!function(a){"undefined"==typeof a.define&&(a.define=function(b,c){try{delete a.define}catch(d){a.define=void 0}"function"==typeof b?a.when=b():a[b]=c()},a.define.amd={});var b={VERSION:"0.1.0",defaults:{perPage:50}};a.DL=b,"undefined"==typeof a.FormData&&(a.FormData=function(){}),b.Client=function(a){this.url=a.url||"http://dl-api.dev/api/public/index.php/",this.appId=a.appId,this.key=a.key,this.keys=new b.KeyValues(this),this.auth=new b.Auth(this),this.files=new b.Files(this),this.system=new b.System(this)},b.Client.prototype.collection=function(a){return new b.Collection(this,a)},b.Client.prototype.channel=function(a,c){var d=this.collection(a);return d.segments=d.segments.replace("collection/","channels/"),new b.Channel(this,d,c)},b.Client.prototype.post=function(a,b){return"undefined"==typeof b&&(b={}),this.request(a,"POST",b)},b.Client.prototype.get=function(a,b){return this.request(a,"GET",b)},b.Client.prototype.put=function(a,b){return this.request(a,"PUT",b)},b.Client.prototype.remove=function(a,b){return this.request(a,"DELETE",b)},b.Client.prototype.request=function(a,b,c){var d,e,f=when.defer(),g=!1;c&&c._sync&&(delete c._sync,g=!0),d=this.getPayload(b,c),e=this.getHeaders(),d instanceof FormData||(e["Content-Type"]="application/json");uxhr(this.url+a,d,{method:b,headers:e,sync:g,success:function(a){var b=null;try{b=JSON.parse(a)}catch(c){}!b||b.error?f.resolver.reject(b):f.resolver.resolve(b)},error:function(a){var b=null;try{b=JSON.parse(a)}catch(c){}console.log("Error: ",b||"invalid json response"),f.resolver.reject(b)}});return f.promise},b.Client.prototype.getHeaders=function(){var c,d={"X-App-Id":this.appId,"X-App-Key":this.key},c=a.localStorage.getItem(this.appId+"-"+b.Auth.AUTH_TOKEN_KEY);return c&&(d["X-Auth-Token"]=c),d},b.Client.prototype.getPayload=function(a,b){var c=null;if(b){if(b instanceof FormData)c=b;else if("GET"!==a){var d,e,f,g=new FormData,h=!1;for(d in b)e=b[d],f=null,e instanceof HTMLInputElement?(f=e.files[0].name,e=e.files[0],h=!0):e instanceof HTMLCanvasElement?(e=dataURLtoBlob(e.toDataURL()),h=!0,f="canvas.png"):e instanceof Blob&&(h=!0,f="blob."+e.type.match(/\/(.*)/)[1]),e instanceof Array||g.append(d,e,f||"file");h&&(c=g)}c=c||JSON.stringify(b),"GET"===a&&"string"==typeof c&&(c=encodeURIComponent(c))}return c},b.Client.prototype.serialize=function(a,b){var c=[];for(var d in a)if(a.hasOwnProperty(d)){var e=b?b+"["+d+"]":d,f=a[d];c.push("object"==typeof f?this.serialize(f,e):encodeURIComponent(e)+"="+encodeURIComponent(f))}return c.join("&")},b.Iterable=function(){},b.Iterable.prototype={each:function(a){return this._iterate("each",a)},find:function(a){return this._iterate("find",a)},filter:function(a){return this._iterate("filter",a)},max:function(a){return this._iterate("max",a)},min:function(a){return this._iterate("min",a)},every:function(a){return this._iterate("every",a)},reject:function(a,b){return this._iterate("reject",a,b)},groupBy:function(a,b){return this._iterate("groupBy",a,b)},_iterate:function(a,b,c){var d=this;return this.then(function(e){_[a].call(d,e,b,c)}),this}},b.Auth=function(c){this.client=c,this.currentUser=null;var d=new Date,e=new Date(1e3*parseInt(a.localStorage.getItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_EXPIRATION)||0,10)),f=a.localStorage.getItem(this.client.appId+"-"+b.Auth.AUTH_DATA_KEY);f&&d.getTime()<e.getTime()&&(this.currentUser=JSON.parse(f))},b.Auth.AUTH_DATA_KEY="dl-api-auth-data",b.Auth.AUTH_TOKEN_KEY="dl-api-auth-token",b.Auth.AUTH_TOKEN_EXPIRATION="dl-api-auth-token-expiration",b.Auth.prototype.setCurrentUser=function(c){return this.currentUser=c,c?a.localStorage.setItem(this.client.appId+"-"+b.Auth.AUTH_DATA_KEY,JSON.stringify(c)):(a.localStorage.removeItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_KEY),a.localStorage.removeItem(this.client.appId+"-"+b.Auth.AUTH_DATA_KEY)),this},b.Auth.prototype.authenticate=function(a,b){var c,d=this;return"undefined"==typeof b&&(b={}),c=this.client.post("auth/"+a,b),c.then(function(a){d.registerToken(a)}),c},b.Auth.prototype.verify=function(a,b){var c,d=this;return"undefined"==typeof b&&(b={}),c=this.client.post("auth/"+a+"/verify",b),c.then(function(a){d.registerToken(a)}),c},b.Auth.prototype.forgotPassword=function(a){return"undefined"==typeof a&&(a={}),this.client.post("auth/email/forgotPassword",a)},b.Auth.prototype.resetPassword=function(b){if("string"==typeof b&&(b={password:b}),"undefined"==typeof b.token&&(b.token=a.location.href.match(/[\?|&]token=([a-z0-9]+)/),b.token=b.token&&b.token[1]),"string"!=typeof b.token)throw new Error("forgot password token required. Remember to use 'auth.forgotPassword' before 'auth.resetPassword'.");if("string"!=typeof b.password)throw new Error("new password required.");return this.client.post("auth/email/resetPassword",b)},b.Auth.prototype.logout=function(){return this.setCurrentUser(null)},b.Auth.prototype.registerToken=function(c){c.token&&(a.localStorage.setItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_KEY,c.token.token),a.localStorage.setItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_EXPIRATION,c.token.expire_at),delete c.token,this.setCurrentUser(c))},b.Channel=function(a,b,c){this.collection=b,this.client_id=null,this.callbacks={},this.options=c||{},this.readyState=null},b.Channel.prototype.subscribe=function(a,b){"undefined"==typeof b&&(b=a,a="_default"),this.callbacks[a]=b;var c=this.connect();if(this.readyState===EventSource.CONNECTING){var d=this;c.then(function(){d.event_source.onopen=function(a){d.readyState=a.readyState,d._trigger.apply(d,["state:"+a.type,a])},d.event_source.onerror=function(a){d.readyState=a.readyState,d._trigger.apply(d,["state:"+a.type,a])},d.event_source.onmessage=function(a){var b=JSON.parse(a.data),c=b.event;delete b.event,d._trigger.apply(d,[c,b])}})}return c},b.Channel.prototype._trigger=function(a,b){-1===a.indexOf("state:")&&this.callbacks._default&&this.callbacks._default.apply(this,[a,b]),this.callbacks[a]&&this.callbacks[a].apply(this,[b])},b.Channel.prototype.isConnected=function(){return null!==this.readyState&&this.readyState!==EventSource.CLOSED},b.Channel.prototype.unsubscribe=function(a){this.callbacks[a]&&(this.callbacks[a]=null)},b.Channel.prototype.publish=function(a,b){return"undefined"==typeof b&&(b={}),b.client_id=this.client_id,b.event=a,this.collection.create(b)},b.Channel.prototype.connect=function(){if(null!==this.readyState){var c=when.defer();return c.resolver.resolve(),c.promise}this.readyState=EventSource.CONNECTING,this._trigger.apply(this,["state:connecting"]);var d=this;return this.publish("connected").then(function(c){d.collection.where("updated_at",">",c.updated_at);var e=d.collection.buildQuery();e["X-App-Id"]=d.collection.client.appId,e["X-App-Key"]=d.collection.client.key;var f=a.localStorage.getItem(e["X-App-Id"]+"-"+b.Auth.AUTH_TOKEN_KEY);f&&(e["X-Auth-Token"]=f),e.stream={refresh:d.options.refresh_timeout||1,retry:d.options.retry_timeout||1},d.client_id=c.client_id,d.event_source=new EventSource(d.collection.client.url+d.collection.segments+"?"+JSON.stringify(e),{withCredentials:!0}),a.addEventListener("unload",function(){d.disconnect(!0)})},function(a){d.readyState=EventSource.CLOSED,d._trigger.apply(d,["state:error",a])})},b.Channel.prototype.disconnect=function(a){return this.isConnected()&&(this.close(),this.publish("disconnected",{_sync:"undefined"!=typeof a&&a})),this},b.Channel.prototype.close=function(){return this.event_source&&this.event_source.close(),this.readyState=EventSource.CLOSED,this},b.Collection=function(a,b){this.client=a,this.name=this._validateName(b),this.reset(),this.segments="collection/"+this.name},b.Collection.prototype=new b.Iterable,b.Collection.prototype.constructor=b.Collection,b.Collection.prototype.create=function(a){return this.client.post(this.segments,a)},b.Collection.prototype.get=function(){return this.client.get(this.segments,this.buildQuery())},b.Collection.prototype.where=function(a,b,c){var d,e="undefined"==typeof c?"=":b,f="undefined"==typeof c?b:c;if("object"==typeof a)for(d in a)a.hasOwnProperty(d)&&(a[d]instanceof Array?(e=a[d][0],f=a[d][1]):f=a[d],this.addWhere(d,e,f));else this.addWhere(a,e,f);return this},b.Collection.prototype.find=function(a){var b=this.client.get(this.segments+"/"+a,this.buildQuery());return arguments.length>1?b.then.apply(b,Array.prototype.slice.call(arguments,1)):b},b.Collection.prototype.group=function(){return this._group=arguments,this},b.Collection.prototype.count=function(){this.options.aggregation={method:"count",field:null};var a=this.get();return arguments.length>0&&a.then.apply(a,arguments),a},b.Collection.prototype.max=function(a){this.options.aggregation={method:"max",field:a};var b=this.get();return arguments.length>1&&b.then.apply(b,Array.prototype.slice.call(arguments,1)),b},b.Collection.prototype.min=function(a){this.options.aggregation={method:"min",field:a};var b=this.get();return arguments.length>1&&b.then.apply(b,Array.prototype.slice.call(arguments,1)),b},b.Collection.prototype.avg=function(a){this.options.aggregation={method:"avg",field:a};var b=this.get();return arguments.length>1&&b.then.apply(b,Array.prototype.slice.call(arguments,1)),b},b.Collection.prototype.sum=function(a){this.options.aggregation={method:"sum",field:a};var b=this.get();return arguments.length>1&&b.then.apply(b,Array.prototype.slice.call(arguments,1)),b},b.Collection.prototype.first=function(){this.options.first=1;var a=this.get();return a.then.apply(a,arguments),a},b.Collection.prototype.firstOrCreate=function(){throw new Error("Not implemented")},b.Collection.prototype.then=function(){var a=this.get();return a.then.apply(a,arguments),a},b.Collection.prototype.reset=function(){return this.options={},this.wheres=[],this.ordering=[],this._group=[],this._limit=null,this._offset=null,this},b.Collection.prototype.sort=function(a,b){return b?"number"==typeof b&&(b=-1===parseInt(b,10)?"desc":"asc"):b="asc",this.ordering.push([a,b]),this},b.Collection.prototype.limit=function(a){return this._limit=a,this},b.Collection.prototype.offset=function(a){return this._offset=a,this},b.Collection.prototype.channel=function(){throw new Error("Not implemented.")},b.Collection.prototype.paginate=function(a,c,d){var e=new b.Pagination(this);return c||(c=a,a=b.defaults.perPage),this.options.paginate=a,this.then(function(a){e._fetchComplete(a),c&&c(e)},d),e},b.Collection.prototype.drop=function(){return this.client.remove(this.segments)},b.Collection.prototype.remove=function(a){var b=this.segments;return"undefined"!=typeof a&&(b+="/"+a),this.client.remove(b,this.buildQuery())},b.Collection.prototype.update=function(a,b){return this.client.post(this.segments+"/"+a,b)},b.Collection.prototype.increment=function(a,b){this.options.operation={method:"increment",field:a,value:b};var c=this.client.put(this.segments,this.buildQuery());return arguments.length>0&&c.then.apply(c,arguments),c},b.Collection.prototype.decrement=function(a,b){this.options.operation={method:"decrement",field:a,value:b};var c=this.client.put(this.segments,this.buildQuery());return arguments.length>0&&c.then.apply(c,arguments),c},b.Collection.prototype.updateAll=function(a){return this.options.data=a,this.client.put(this.segments,this.buildQuery())},b.Collection.prototype.addWhere=function(a,b,c){return this.wheres.push([a,b.toLowerCase(),c]),this},b.Collection.prototype._validateName=function(a){var b=/^[a-z_\/0-9]+$/;if(!b.test(a))throw new Error("Invalid name: "+a);return a},b.Collection.prototype.buildQuery=function(){var a={};null!==this._limit&&(a.limit=this._limit),null!==this._offset&&(a.offset=this._offset),this.wheres.length>0&&(a.q=this.wheres),this.ordering.length>0&&(a.s=this.ordering),this._group.length>0&&(a.g=this._group);var b,c={paginate:"p",first:"f",aggregation:"aggr",operation:"op"};for(b in c)this.options[b]&&(a[c[b]]=this.options[b]);return this.reset(),a},b.CollectionItem=function(a){this.collection=a,this.name=this._validateName(name),this.reset(),this.segments="collection/"+this.name},b.Files=function(a){this.client=a},b.Files.prototype.upload=function(a,b,c){var d=new FormData;if(a instanceof HTMLCanvasElement&&a.toBlob){var e=when.defer(),f=this;return a.toBlob(function(a){f.upload(a,b,c).then(e.resolver.resolve,e.resolver.reject)},c||"image/png"),e.promise}return d.append("file",a,b||"dlApiFile"),this.client.post("files",d)},b.Files.prototype.get=function(a){return this.client.get("files/"+a)},b.Files.prototype.remove=function(a){return this.client.remove("files/"+a)},b.KeyValues=function(a){this.client=a},b.KeyValues.prototype.get=function(a,b){var c=this.client.get("key/"+a);return b&&c.then.apply(c,[b]),c},b.KeyValues.prototype.set=function(a,b){return this.client.post("key/"+a,{value:b})},b.Pagination=function(a){this.fetching=!0,this.collection=a},b.Pagination.prototype._fetchComplete=function(a){this.fetching=!1,this.total=a.total,this.per_page=a.per_page,this.current_page=a.current_page,this.last_page=a.last_page,this.from=a.from,this.to=a.to,this.items=a.data},b.Pagination.prototype.hasNext=function(){return this.current_page<this.to},b.Pagination.prototype.isFetching=function(){return this.fetching},b.Pagination.prototype.then=function(){},b.System=function(a){this.client=a},b.System.prototype.time=function(){var a=this.client.get("system/time");return arguments.length>0&&a.then.apply(a,arguments),a}}(this);